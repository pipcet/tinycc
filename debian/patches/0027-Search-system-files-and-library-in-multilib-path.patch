From 4e1749d9be4dd7da305830ca60929a11504d3613 Mon Sep 17 00:00:00 2001
From: Thomas Preud'homme <thomas.preudhomme@celest.fr>
Date: Sat, 9 Jul 2011 12:04:15 +0200
Subject: Search system files and library in multilib path

Search crt*.o, libraries and headers in multiarch subdirectories as well
for all system directories tried. Also generate multiarch elf
interpreter if available on local system, normal elf interpreter else.

Origin: vendor
Bug-Debian: http://bugs.debian.org/632089
Forwarded: http://lists.nongnu.org/archive/html/tinycc-devel/2011-07/msg00016.html
Last-Updated: 2011-07-11
---
 configure |   38 +++++++++++++++---------
 libtcc.c  |   95 +++++++++++++++++++++++++++++++++++++++++++++++++++++++-----
 libtcc.h  |    8 +++++
 tcc.h     |    2 +
 tccelf.c  |   45 ++++++++++++++++++++++-------
 5 files changed, 154 insertions(+), 34 deletions(-)

diff --git a/configure b/configure
index 2dad1e6..ef9e51d 100755
--- a/configure
+++ b/configure
@@ -24,6 +24,7 @@ prefix=""
 execprefix=""
 bindir=""
 libdir=""
+multilib_subdir=""
 tccdir=""
 includedir=""
 mandir=""
@@ -103,6 +104,8 @@ for opt do
   ;;
   --libdir=*) libdir=`echo $opt | cut -d '=' -f 2`
   ;;
+  --multilib-subdir=*) multilib_subdir=`echo $opt | cut -d '=' -f 2`
+  ;;
   --includedir=*) includedir=`echo $opt | cut -d '=' -f 2`
   ;;
   --mandir=*) mandir=`echo $opt | cut -d '=' -f 2`
@@ -229,6 +232,7 @@ echo "Advanced options (experts only):"
 echo "  --source-path=PATH       path of source code [$source_path]"
 echo "  --cross-prefix=PREFIX    use PREFIX for compile tools [$cross_prefix]"
 echo "  --sysroot=PREFIX         prepend PREFIX to library/include paths []"
+echo "  --multilib_subdir=DIR    multilib subdirectory in DIR []"
 echo "  --cc=CC                  use C compiler CC [$cc]"
 echo "  --with-libgcc            use /lib/libgcc_s.so.1 instead of libtcc1.a"
 echo ""
@@ -275,21 +279,22 @@ if test x"$includedir" = x""; then
 includedir="${prefix}/include"
 fi
 
-echo "Binary  directory   $bindir"
-echo "TinyCC directory    $tccdir"
-echo "Library directory   $libdir"
-echo "Include directory   $includedir"
-echo "Manual directory    $mandir"
-echo "Info directory      $infodir"
-echo "Doc directory       $docdir"
-echo "Target root prefix  $sysroot"
-echo "Source path      $source_path"
-echo "C compiler       $cc"
-echo "CPU              $cpu"
-echo "Big Endian       $bigendian"
-echo "gprof enabled    $gprof"
-echo "cross compilers  $build_cross"
-echo "use libgcc       $use_libgcc"
+echo "Binary  directory      $bindir"
+echo "TinyCC directory       $tccdir"
+echo "Library directory      $libdir"
+echo "Multilib subdirectory  $multilib_subdir"
+echo "Include directory      $includedir"
+echo "Manual directory       $mandir"
+echo "Info directory         $infodir"
+echo "Doc directory          $docdir"
+echo "Target root prefix     $sysroot"
+echo "Source path            $source_path"
+echo "C compiler             $cc"
+echo "CPU                    $cpu"
+echo "Big Endian             $bigendian"
+echo "gprof enabled          $gprof"
+echo "cross compilers        $build_cross"
+echo "use libgcc             $use_libgcc"
 
 echo "Creating config.mak and config.h"
 
@@ -307,6 +312,9 @@ echo "docdir=\$(DESTDIR)$docdir" >> config.mak
 
 echo "#define CONFIG_SYSROOT \"$sysroot\"" >> $TMPH
 echo "#define CONFIG_TCCDIR \"$tccdir\"" >> $TMPH
+if test -n "$multilib_subdir" ; then
+  echo "#define CONFIG_TCC_MULTILIB_SUBDIR \"$multilib_subdir\"" >> $TMPH
+fi
 echo "CC=$cc" >> config.mak
 echo "GCC_MAJOR=$gcc_major" >> config.mak
 echo "#define GCC_MAJOR $gcc_major" >> $TMPH
diff --git a/libtcc.c b/libtcc.c
index dc9c885..d192203 100644
--- a/libtcc.c
+++ b/libtcc.c
@@ -211,6 +211,7 @@ static int tcc_add_dll(TCCState *s, const char *filename, int flags);
 #define AFF_PRINT_ERROR     0x0001 /* print error if file not found */
 #define AFF_REFERENCED_DLL  0x0002 /* load a referenced dll from another dll */
 #define AFF_PREPROCESS      0x0004 /* preprocess file */
+#define AFF_MULTILIB        0x0008 /* also search multilib subdir */
 static int tcc_add_file_internal(TCCState *s, const char *filename, int flags);
 
 /* tcccoff.c */
@@ -1857,9 +1858,9 @@ TCCState *tcc_new(void)
     
 #ifndef TCC_TARGET_PE
     /* default library paths */
-    tcc_add_library_path(s, CONFIG_SYSROOT "/usr/local/lib");
-    tcc_add_library_path(s, CONFIG_SYSROOT "/usr/lib");
-    tcc_add_library_path(s, CONFIG_SYSROOT "/lib");
+    tcc_add_syslibrary_path(s, CONFIG_SYSROOT "/usr/local/lib");
+    tcc_add_syslibrary_path(s, CONFIG_SYSROOT "/usr/lib");
+    tcc_add_syslibrary_path(s, CONFIG_SYSROOT "/lib");
 #endif
 
     /* no section zero */
@@ -1919,6 +1920,7 @@ void tcc_delete(TCCState *s1)
 
     /* free library paths */
     dynarray_reset(&s1->library_paths, &s1->nb_library_paths);
+    dynarray_reset(&s1->syslibrary_paths, &s1->nb_syslibrary_paths);
 
     /* free include paths */
     dynarray_reset(&s1->cached_includes, &s1->nb_cached_includes);
@@ -1941,6 +1943,17 @@ int tcc_add_sysinclude_path(TCCState *s1, const char *pathname)
 {
     char *pathname1;
     
+#ifdef CONFIG_TCC_MULTILIB_SUBDIR
+    {
+        int len;
+        char *pathname2;
+
+        len = strlen(pathname) + strlen(CONFIG_TCC_MULTILIB_SUBDIR) + 2;
+        pathname2 = tcc_malloc(len);
+        snprintf(pathname2, len, "%s/%s", pathname, CONFIG_TCC_MULTILIB_SUBDIR);
+        dynarray_add((void ***)&s1->sysinclude_paths, &s1->nb_sysinclude_paths, pathname2);
+    }
+#endif
     pathname1 = tcc_strdup(pathname);
     dynarray_add((void ***)&s1->sysinclude_paths, &s1->nb_sysinclude_paths, pathname1);
     return 0;
@@ -1952,6 +1965,9 @@ static int tcc_add_file_internal(TCCState *s1, const char *filename, int flags)
     ElfW(Ehdr) ehdr;
     int fd, ret;
     BufferedFile *saved_file;
+#ifdef CONFIG_TCC_MULTILIB_SUBDIR
+    char buf[1024];
+#endif
 
     /* find source file type with extension */
     ext = tcc_fileextension(filename);
@@ -1960,6 +1976,20 @@ static int tcc_add_file_internal(TCCState *s1, const char *filename, int flags)
 
     /* open the file */
     saved_file = file;
+#ifdef CONFIG_TCC_MULTILIB_SUBDIR
+    if (flags & AFF_MULTILIB) {
+        char *base;
+
+        base = tcc_basename(filename);
+        snprintf(buf, sizeof(buf), "%.*s/%s/%s", (int) (base - filename - 1),
+                 filename, CONFIG_TCC_MULTILIB_SUBDIR, base);
+        file = tcc_open(s1, buf);
+        if (file) {
+            filename = buf;
+            goto file_opened;
+        }
+    }
+#endif
     file = tcc_open(s1, filename);
     if (!file) {
         if (flags & AFF_PRINT_ERROR) {
@@ -1969,6 +1999,9 @@ static int tcc_add_file_internal(TCCState *s1, const char *filename, int flags)
         goto fail1;
     }
 
+#ifdef CONFIG_TCC_MULTILIB_SUBDIR
+file_opened:
+#endif
     if (flags & AFF_PREPROCESS) {
         ret = tcc_preprocess(s1);
     } else if (!ext[0] || !PATHCMP(ext, "c")) {
@@ -2062,12 +2095,22 @@ static int tcc_add_file_internal(TCCState *s1, const char *filename, int flags)
     goto the_end;
 }
 
-int tcc_add_file(TCCState *s, const char *filename)
+int tcc_add_file2(TCCState *s, const char *filename, int flags)
 {
     if (s->output_type == TCC_OUTPUT_PREPROCESS)
-        return tcc_add_file_internal(s, filename, AFF_PRINT_ERROR | AFF_PREPROCESS);
+        return tcc_add_file_internal(s, filename, AFF_PRINT_ERROR | AFF_PREPROCESS | flags);
     else
-        return tcc_add_file_internal(s, filename, AFF_PRINT_ERROR);
+        return tcc_add_file_internal(s, filename, AFF_PRINT_ERROR | flags);
+}
+
+int tcc_add_file(TCCState *s, const char *filename)
+{
+    return tcc_add_file2(s, filename, 0);
+}
+
+int tcc_add_sysfile(TCCState *s, const char *filename)
+{
+    return tcc_add_file2(s, filename, AFF_MULTILIB);
 }
 
 int tcc_add_library_path(TCCState *s, const char *pathname)
@@ -2079,6 +2122,26 @@ int tcc_add_library_path(TCCState *s, const char *pathname)
     return 0;
 }
 
+int tcc_add_syslibrary_path(TCCState *s, const char *pathname)
+{
+    char *pathname1;
+
+#ifdef CONFIG_TCC_MULTILIB_SUBDIR
+    {
+        int len;
+        char *pathname2;
+
+        len = strlen(pathname) + strlen(CONFIG_TCC_MULTILIB_SUBDIR) + 2;
+        pathname2 = tcc_malloc(len);
+        snprintf(pathname2, len, "%s/%s", pathname, CONFIG_TCC_MULTILIB_SUBDIR);
+        dynarray_add((void ***)&s->syslibrary_paths, &s->nb_syslibrary_paths, pathname2);
+    }
+#endif
+    pathname1 = tcc_strdup(pathname);
+    dynarray_add((void ***)&s->syslibrary_paths, &s->nb_syslibrary_paths, pathname1);
+    return 0;
+}
+
 /* find and load a dll. Return non zero if not found */
 /* XXX: add '-rpath' option support ? */
 static int tcc_add_dll(TCCState *s, const char *filename, int flags)
@@ -2092,6 +2155,14 @@ static int tcc_add_dll(TCCState *s, const char *filename, int flags)
         if (tcc_add_file_internal(s, buf, flags) == 0)
             return 0;
     }
+#ifdef CONFIG_TCC_MULTILIB_SUBDIR
+    for(i = 0; i < s->nb_syslibrary_paths; i++) {
+        snprintf(buf, sizeof(buf), "%s/%s",
+                 s->syslibrary_paths[i], filename);
+        if (tcc_add_file_internal(s, buf, flags) == 0)
+            return 0;
+    }
+#endif
     return -1;
 }
 
@@ -2119,6 +2190,14 @@ int tcc_add_library(TCCState *s, const char *libraryname)
         if (tcc_add_file_internal(s, buf, 0) == 0)
             return 0;
     }
+#ifdef CONFIG_TCC_MULTILIB_SUBDIR
+    for (i = 0; i < s->nb_syslibrary_paths; i++) {
+        snprintf(buf, sizeof(buf), "%s/lib%s.a",
+                 s->syslibrary_paths[i], libraryname);
+        if (tcc_add_file_internal(s, buf, 0) == 0)
+            return 0;
+    }
+#endif
     return -1;
 }
 
@@ -2185,8 +2264,8 @@ int tcc_set_output_type(TCCState *s, int output_type)
     if ((output_type == TCC_OUTPUT_EXE || output_type == TCC_OUTPUT_DLL) &&
         !s->nostdlib) {
         if (output_type != TCC_OUTPUT_DLL)
-            tcc_add_file(s, CONFIG_TCC_CRT_PREFIX "/crt1.o");
-        tcc_add_file(s, CONFIG_TCC_CRT_PREFIX "/crti.o");
+            tcc_add_sysfile(s, CONFIG_TCC_CRT_PREFIX "/crt1.o");
+        tcc_add_sysfile(s, CONFIG_TCC_CRT_PREFIX "/crti.o");
     }
 #endif
 
diff --git a/libtcc.h b/libtcc.h
index 96070e2..cd57f7f 100644
--- a/libtcc.h
+++ b/libtcc.h
@@ -53,6 +53,11 @@ LIBTCCAPI void tcc_undefine_symbol(TCCState *s, const char *sym);
    script). Return -1 if error. */
 LIBTCCAPI int tcc_add_file(TCCState *s, const char *filename);
 
+/* add a system file (either a C file, dll, an object, a library or an
+   ld script). This file will also be searched in multilib subdir.
+   Return -1 if error. */
+LIBTCCAPI int tcc_add_sysfile(TCCState *s, const char *filename);
+
 /* compile a string containing a C source. Return non zero if
    error. */
 LIBTCCAPI int tcc_compile_string(TCCState *s, const char *buf);
@@ -76,6 +81,9 @@ LIBTCCAPI int tcc_set_output_type(TCCState *s, int output_type);
 /* equivalent to -Lpath option */
 LIBTCCAPI int tcc_add_library_path(TCCState *s, const char *pathname);
 
+/* Each system library path is searched with and without multilib subdir */
+LIBTCCAPI int tcc_add_syslibrary_path(TCCState *s, const char *pathname);
+
 /* the library name is the same as the argument of the '-l' option */
 LIBTCCAPI int tcc_add_library(TCCState *s, const char *libraryname);
 
diff --git a/tcc.h b/tcc.h
index eb42adc..430b808 100644
--- a/tcc.h
+++ b/tcc.h
@@ -386,6 +386,8 @@ struct TCCState {
 
     char **library_paths;
     int nb_library_paths;
+    char **syslibrary_paths;
+    int nb_syslibrary_paths;
 
     /* array of all loaded dlls (including those referenced by loaded
        dlls) */
diff --git a/tccelf.c b/tccelf.c
index 96c641e..804b30e 100644
--- a/tccelf.c
+++ b/tccelf.c
@@ -1202,7 +1202,7 @@ static void tcc_add_runtime(TCCState *s1)
         tcc_add_library(s1, "c");
 
 #ifdef CONFIG_USE_LIBGCC
-        tcc_add_file(s1, CONFIG_SYSROOT "/lib/libgcc_s.so.1");
+        tcc_add_sysfile(s1, CONFIG_SYSROOT "/lib/libgcc_s.so.1");
 #else
 #ifndef WITHOUT_LIBTCC
         snprintf(buf, sizeof(buf), "%s/%s", s1->tcc_lib_path, "libtcc1.a");
@@ -1212,7 +1212,7 @@ static void tcc_add_runtime(TCCState *s1)
     }
     /* add crt end if not memory output */
     if (s1->output_type != TCC_OUTPUT_MEMORY && !s1->nostdlib) {
-        tcc_add_file(s1, CONFIG_TCC_CRT_PREFIX "/crtn.o");
+        tcc_add_sysfile(s1, CONFIG_TCC_CRT_PREFIX "/crtn.o");
     }
 }
 
@@ -1277,21 +1277,27 @@ static void tcc_add_linker_symbols(TCCState *s1)
 }
 
 /* name of ELF interpreter */
+#ifdef CONFIG_TCC_MULTILIB_SUBDIR
+#define MULTILIB_SUBDIR CONFIG_TCC_MULTILIB_SUBDIR
+#else
+#define MULTILIB_SUBDIR ""
+#endif
 #if defined __FreeBSD__
-static char elf_interp[] = "/libexec/ld-elf.so.1";
+static char elf_interp[] = "/libexec/"MULTILIB_SUBDIR"/ld-elf.so.1";
 #elif defined __FreeBSD_kernel__
-static char elf_interp[] = "/lib/ld.so.1";
+static char elf_interp[] = "/lib/"MULTILIB_SUBDIR"/ld.so.1";
 #elif defined __gnu_hurd__
-static char elf_interp[] = "/lib/ld.so";
+static char elf_interp[] = "/lib/"MULTILIB_SUBDIR"/ld.so";
 #elif defined TCC_ARM_EABI
-static char elf_interp[] = "/lib/ld-linux.so.3";
+static char elf_interp[] = "/lib/"MULTILIB_SUBDIR"/ld-linux.so.3";
 #elif defined(TCC_TARGET_X86_64)
-static char elf_interp[] = "/lib/ld-linux-x86-64.so.2";
+static char elf_interp[] = "/lib/"MULTILIB_SUBDIR"/ld-linux-x86-64.so.2";
 #elif defined(TCC_UCLIBC)
-static char elf_interp[] = "/lib/ld-uClibc.so.0";
+static char elf_interp[] = "/lib/"MULTILIB_SUBDIR"/ld-uClibc.so.0";
 #else
-static char elf_interp[] = "/lib/ld-linux.so.2";
+static char elf_interp[] = "/lib/"MULTILIB_SUBDIR"/ld-linux.so.2";
 #endif
+#undef MULTILIB_SUBDIR
 
 static void tcc_output_binary(TCCState *s1, FILE *f,
                               const int *section_order)
@@ -1399,8 +1405,25 @@ int elf_output_file(TCCState *s1, const char *filename)
                 char *ptr;
 		/* allow override the dynamic loader */
 		const char *elfint = getenv("LD_SO");
-		if (elfint == NULL)
-		    elfint = elf_interp;
+		if (elfint == NULL) {
+#ifdef CONFIG_TCC_MULTILIB_SUBDIR
+                    BufferedFile *file;
+
+                    file = tcc_open(s1, elf_interp);
+                    if (file)
+                        tcc_close(file);
+                    else {
+                        char *base, *p;
+
+                        base = tcc_basename(elf_interp);
+                        p = base - 1;
+                        while (p[-1] != '/')
+                            --p;
+                        pstrcpy(p, strlen(elf_interp), base);
+                    }
+#endif
+                    elfint = elf_interp;
+                }
                 /* add interpreter section only if executable */
                 interp = new_section(s1, ".interp", SHT_PROGBITS, SHF_ALLOC);
                 interp->sh_addralign = 1;
-- 
1.7.5.4

