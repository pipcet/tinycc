From f5187fd3fdefd2be5fbe4893476db7e62c07decf Mon Sep 17 00:00:00 2001
From: Thomas Preud'homme <robotux@celest.fr>
Date: Thu, 15 Mar 2012 00:22:00 +0100
Subject: Support linker options passed in several -Wl param

ld support arguments to multiple-letter options being passed in two
ways:
* -opt=arg
* -opt arg

libtool generate command line of the second form. This commit add
support for the second form so that libtool works with tcc. The way it
is done is to concatenate all -Wl options into one and then pass it to
set_linker.

Origin: vendor
Bug-Debian: http://bugs.debian.org/663693
Forwarded: http://lists.nongnu.org/archive/html/tinycc-devel/2012-03/msg00033.html
Last-Update: 2012-04-10
Applied-Upstream: commit: 16202e054f0385499ec16463b87e23c97dc02328
---
 libtcc.c |    3 +++
 tcc.c    |   18 ++++++++++++++++--
 2 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/libtcc.c b/libtcc.c
index 8f5cd0e..8aadc8f 100644
--- a/libtcc.c
+++ b/libtcc.c
@@ -1566,6 +1566,9 @@ PUB_FUNC const char * tcc_set_linker(TCCState *s, char *option, int multi)
             s->has_text_addr = 1;
 
         } else {
+            char *comma_ptr = strchr(option, ',');
+            if (comma_ptr)
+                *comma_ptr = '\0';
             return option;
         }
 
diff --git a/tcc.c b/tcc.c
index 0c51451..2d491d4 100644
--- a/tcc.c
+++ b/tcc.c
@@ -35,6 +35,7 @@ static int do_bench = 0;
 static int gen_deps;
 static const char *deps_outfile;
 static const char *m_option;
+static char *linker_arg;
 
 #define TCC_OPTION_HAS_ARG 0x0001
 #define TCC_OPTION_NOSEP   0x0002 /* cannot have space before option and arg */
@@ -280,6 +281,7 @@ static int parse_args(TCCState *s, int argc, char **argv)
     const char *optarg, *p1, *r1;
     char *r;
     int was_pthread;
+    unsigned long linker_argsize = 0;
 
     was_pthread = 0; /* is set if commandline contains -pthread key */
 
@@ -442,8 +444,17 @@ static int parse_args(TCCState *s, int argc, char **argv)
                 s->rdynamic = 1;
                 break;
             case TCC_OPTION_Wl:
-                if ((r = (char *) tcc_set_linker(s, (char *)optarg, TRUE)))
-                    tcc_error("unsupported linker option '%s'", r);
+                if (!linker_arg) {
+                    linker_argsize = strlen(optarg) + 1;
+                    linker_arg = tcc_malloc(linker_argsize);
+                    pstrcpy(linker_arg, linker_argsize, optarg);
+                }
+                else {
+                    linker_argsize += strlen(optarg) + 1;
+                    linker_arg = tcc_realloc(linker_arg, linker_argsize);
+                    pstrcat(linker_arg, linker_argsize, ",");
+                    pstrcat(linker_arg, linker_argsize, optarg);
+                }
                 break;
             case TCC_OPTION_E:
                 output_type = TCC_OUTPUT_PREPROCESS;
@@ -465,6 +476,8 @@ static int parse_args(TCCState *s, int argc, char **argv)
             }
         }
     }
+    if ((r = (char *) tcc_set_linker(s, (char *)linker_arg, TRUE)))
+        tcc_error("unsupported linker option '%s'", r);
     /* fixme: these options could be different on your platform */
     if (was_pthread && output_type != TCC_OUTPUT_OBJ) {
         dynarray_add((void ***)&files, &nb_files, "-lpthread");
@@ -593,6 +606,7 @@ int main(int argc, char **argv)
     }
 
     tcc_delete(s);
+    tcc_free(linker_arg);
     tcc_free(outfile);
 
 #ifdef MEM_DEBUG
